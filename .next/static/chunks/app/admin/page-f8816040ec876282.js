(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3],{7123:function(e,t,a){Promise.resolve().then(a.bind(a,306))},306:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return m}});var n=a(7437),r=a(4819),s=a(2265),l=a(7374),i=a(5735),o=a(9506),d=a(9842),c=a(9783),u=a(8726);function m(){return(0,n.jsx)(r.Z,{allowed:["admin"],children:(0,n.jsx)(h,{})})}function h(){let[e,t]=(0,s.useState)(""),[a,r]=(0,s.useState)(""),[m,h]=(0,s.useState)("JSS1"),[p,f]=(0,s.useState)(""),[g,x]=(0,s.useState)("Mathematics, English"),[v,b]=(0,s.useState)(),[N,w]=(0,s.useState)(!1),[j,y]=(0,s.useState)(null),[S,E]=(0,s.useState)(null),[A,I]=(0,s.useState)(null),[C,D]=(0,s.useState)(""),[_,L]=(0,s.useState)(""),[U,B]=(0,s.useState)("JSS1,JSS2"),[P,T]=(0,s.useState)(null),[R,F]=(0,s.useState)(""),[O,J]=(0,s.useState)([]),[M,q]=(0,s.useState)(null),[k,G]=(0,s.useState)(""),[Q,X]=(0,s.useState)(""),[Z,K]=(0,s.useState)(""),[H,Y]=(0,s.useState)(null),[W,z]=(0,s.useState)(null);async function V(){let{students:e,cursor:t}=await (0,l.QN)(10);J(e),z(t)}async function $(){if(!W)return;let{students:e,cursor:t}=await (0,l.QN)(10,W);J(t=>[...t,...e]),z(t)}async function ee(){if(!R.trim()){J([]);return}J(await (0,l.l6)(R.trim()))}async function et(e){if(!e){u.ZP.error("Missing student ID");return}try{let t="".concat(window.location.origin,"/student-id/").concat(e),a=await c.toDataURL(t,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}});await (0,d.r7)((0,d.JU)(o.db,"students",e),{qrCode:a,qrGeneratedAt:new Date,qrGeneratedBy:"admin",qrHistory:[{generatedAt:new Date,generatedBy:"admin"}]}),u.ZP.success("QR code generated"),J(t=>t.map(t=>t.id===e?{...t,qrCode:a}:t))}catch(e){console.error("QR generation failed",e),u.ZP.error(e.message||"Failed to generate QR")}}async function ea(e){if(!e){u.ZP.error("Missing student ID");return}let t=await (0,l.Wv)(e);if(!t){u.ZP.error("Student not found");return}q(e),G(t.firstName||""),X(t.lastName||""),K(t.classLevel||""),Y(null)}async function en(e){if(e.preventDefault(),M)try{await (0,d.pl)((0,d.JU)(o.db,"students",M),{firstName:k,lastName:Q,classLevel:Z},{merge:!0}),Y("Updated"),await ee(),setTimeout(()=>Y(null),1500)}catch(e){Y(e.message)}}async function er(e){if(confirm("Delete student permanently?"))try{await (0,d.pl)((0,d.JU)(o.db,"students",e),{deleted:!0},{merge:!0}),J(t=>t.filter(t=>t.id!==e))}catch(e){console.error(e)}}async function es(e){e.preventDefault(),T(null);try{let e=await (0,i.Xb)(o.I,C.trim(),_);await (0,d.pl)((0,d.JU)(o.db,"users",e.user.uid),{role:"teacher",classLevels:U.split(",").map(e=>e.trim()).filter(Boolean)},{merge:!0}),T("Teacher account created"),D(""),L("")}catch(e){T(e.message)}}async function el(n){n.preventDefault(),w(!0),I(null);try{let n=await (0,l.tS)({firstName:e,lastName:a,classLevel:m,parentEmail:p||void 0,subjects:g.split(",").map(e=>e.trim()).filter(Boolean),photoFile:v});y(n.qrDataUrl),E(n.student.id),I("Student created successfully."),t(""),r(""),f(""),x("Mathematics, English"),b(void 0)}catch(e){I(e.message||"Failed")}finally{w(!1)}}return(0,n.jsxs)("div",{className:"max-w-6xl mx-auto py-12 px-6 space-y-10",children:[(0,n.jsxs)("section",{className:"grid md:grid-cols-2 gap-8",children:[(0,n.jsxs)("form",{onSubmit:el,className:"card space-y-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold",children:"Add Student"}),(0,n.jsxs)("div",{className:"grid gap-3 grid-cols-2",children:[(0,n.jsx)("input",{placeholder:"First Name",value:e,onChange:e=>t(e.target.value),required:!0}),(0,n.jsx)("input",{placeholder:"Last Name",value:a,onChange:e=>r(e.target.value),required:!0}),(0,n.jsx)("input",{placeholder:"Class Level",value:m,onChange:e=>h(e.target.value),required:!0}),(0,n.jsx)("input",{placeholder:"Parent Email (optional)",value:p,onChange:e=>f(e.target.value)})]}),(0,n.jsx)("input",{placeholder:"Subjects (comma separated)",value:g,onChange:e=>x(e.target.value)}),(0,n.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t;return b(null===(t=e.target.files)||void 0===t?void 0:t[0])}}),(0,n.jsx)("button",{className:"btn",type:"submit",disabled:N,children:N?"Saving...":"Create Student"}),A&&(0,n.jsx)("p",{className:"text-sm text-white/70",children:A}),j&&S&&(0,n.jsxs)("div",{className:"text-xs mt-2 space-y-2",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"ID:"})," ",S]}),(0,n.jsx)("img",{src:j,className:"w-32"})]})]}),(0,n.jsxs)("form",{onSubmit:es,className:"card space-y-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold",children:"Create Teacher"}),(0,n.jsx)("input",{placeholder:"Email",value:C,onChange:e=>D(e.target.value),required:!0}),(0,n.jsx)("input",{placeholder:"Password",type:"password",value:_,onChange:e=>L(e.target.value),required:!0}),(0,n.jsx)("input",{placeholder:"Class Levels (comma)",value:U,onChange:e=>B(e.target.value)}),(0,n.jsx)("button",{className:"btn",type:"submit",children:"Create"}),P&&(0,n.jsx)("p",{className:"text-sm text-white/70",children:P})]})]}),(0,n.jsxs)("section",{className:"card",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Manage Students"}),(0,n.jsxs)("div",{className:"flex gap-3 mb-4",children:[(0,n.jsx)("input",{placeholder:"Search",value:R,onChange:e=>F(e.target.value)}),(0,n.jsx)("button",{className:"btn",type:"button",onClick:ee,disabled:!R.trim(),children:"Search"}),(0,n.jsx)("button",{className:"btn outline",type:"button",onClick:()=>{F(""),V()},children:"Load First Page"})]}),O.length>0&&(0,n.jsx)("div",{className:"overflow-auto",children:(0,n.jsxs)("table",{className:"table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Photo"}),(0,n.jsx)("th",{children:"Name"}),(0,n.jsx)("th",{children:"ID"}),(0,n.jsx)("th",{children:"Class"}),(0,n.jsx)("th",{children:"QR"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:O.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.photoUrl?(0,n.jsx)("img",{src:e.photoUrl,className:"w-10 h-10 object-cover rounded"}):(0,n.jsx)("span",{className:"text-xs text-white/40",children:"No Photo"})}),(0,n.jsxs)("td",{children:[e.firstName," ",e.lastName]}),(0,n.jsx)("td",{children:(0,n.jsx)("span",{className:"badge",children:e.id})}),(0,n.jsx)("td",{children:e.classLevel}),(0,n.jsx)("td",{children:e.qrCode?(0,n.jsxs)("div",{className:"flex flex-col items-start gap-1",children:[(0,n.jsx)("img",{src:e.qrCode,className:"w-14 h-14 object-contain border border-white/10 rounded"}),(0,n.jsx)("span",{className:"text-[10px] text-green-400",children:"Has QR"})]}):(0,n.jsx)("button",{type:"button",className:"btn outline text-xs",onClick:()=>et(e.id),children:"Generate"})}),(0,n.jsxs)("td",{className:"flex gap-2",children:[(0,n.jsx)("button",{className:"btn outline",onClick:()=>ea(e.id),type:"button",children:"Edit"}),(0,n.jsx)("button",{className:"btn outline",onClick:()=>er(e.id),type:"button",children:"Delete"})]})]},e.id))})]})}),!R.trim()&&W&&(0,n.jsx)("button",{className:"btn mt-4",type:"button",onClick:$,children:"Load More"}),M&&(0,n.jsxs)("form",{onSubmit:en,className:"mt-6 p-4 rounded-lg border border-white/10 bg-white/5 space-y-3",children:[(0,n.jsxs)("h3",{className:"font-semibold text-sm",children:["Edit: ",M]}),(0,n.jsxs)("div",{className:"grid md:grid-cols-3 gap-3",children:[(0,n.jsx)("input",{value:k,onChange:e=>G(e.target.value)}),(0,n.jsx)("input",{value:Q,onChange:e=>X(e.target.value)}),(0,n.jsx)("input",{value:Z,onChange:e=>K(e.target.value)})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("button",{className:"btn",type:"submit",children:"Save"}),(0,n.jsx)("button",{className:"btn outline",type:"button",onClick:()=>q(null),children:"Cancel"})]}),H&&(0,n.jsx)("p",{className:"text-xs text-white/70",children:H})]})]})]})}},4819:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var n=a(7437),r=a(2265),s=a(6463),l=a(9630);function i(e){let{allowed:t,children:a}=e,{loading:i,roleInfo:o,isOverrideAdmin:d}=(0,l.a)(),c=(0,s.useRouter)(),u=(null==o?void 0:o.role)||(d?"admin":null);return((0,r.useEffect)(()=>{i||u&&t.includes(u)||c.replace("/login")},[i,u,t,c]),i)?(0,n.jsx)("p",{className:"text-center py-10 text-white/80",children:"Loading..."}):u&&t.includes(u)?(0,n.jsx)(n.Fragment,{children:a}):null}},9630:function(e,t,a){"use strict";a.d(t,{AuthProvider:function(){return d},a:function(){return c}});var n=a(7437),r=a(2265),s=a(5735),l=a(9842),i=a(9506);let o=(0,r.createContext)({user:null,loading:!0,roleInfo:null,logout:async()=>{},isOverrideAdmin:!1,enableAdminOverride:()=>{}}),d=e=>{let{children:t}=e,[a,d]=(0,r.useState)(null),[c,u]=(0,r.useState)(!0),[m,h]=(0,r.useState)(null),[p,f]=(0,r.useState)(!!localStorage.getItem("overrideAdmin"));async function g(){localStorage.removeItem("overrideAdmin"),i.I.currentUser&&await (0,s.w7)(i.I)}return(0,r.useEffect)(()=>{let e=(0,s.Aj)(i.I,async e=>{d(e);let t=localStorage.getItem("pendingRole");if(e){let a=(0,l.JU)(i.db,"users",e.uid),n=await (0,l.QT)(a);if(n.exists()){let e=n.data();h({role:e.role,studentId:e.studentId,classLevels:e.classLevels})}else t?h({role:t}):h(null)}else h(null);u(!1),t&&localStorage.removeItem("pendingRole")});return()=>e()},[]),(0,n.jsx)(o.Provider,{value:{user:a,loading:c,roleInfo:m||(p?{role:"admin"}:null),logout:g,isOverrideAdmin:p,enableAdminOverride:function(){localStorage.setItem("overrideAdmin","true"),f(!0),h({role:"admin"})}},children:t})},c=()=>(0,r.useContext)(o)},7374:function(e,t,a){"use strict";a.d(t,{BM:function(){return N},Gc:function(){return u},KD:function(){return o},O7:function(){return j},QN:function(){return x},Wv:function(){return f},YF:function(){return m},_8:function(){return d},_l:function(){return b},b0:function(){return c},iM:function(){return w},l6:function(){return g},tS:function(){return p},y7:function(){return v}});var n=a(9506),r=a(9842),s=a(2107),l=a(9783),i=a(357);async function o(e){try{var t,a;let s=await (0,r.QT)((0,r.JU)(n.db,"students",e));if(!s.exists())return null;let l=s.data(),i=l.name||[l.firstName,l.lastName].filter(Boolean).join(" ").trim();return{id:s.id,name:i,firstName:l.firstName,lastName:l.lastName,class:l.class||l.classLevel||"",classLevel:l.classLevel,email:l.email,age:l.age||0,rollNumber:l.rollNumber||l.id||"",parentPhone:l.parentPhone,parentEmail:l.parentEmail,photoUrl:l.photoUrl,qrCode:l.qrCode,registeredBy:l.registeredBy||"admin",registeredByUid:l.registeredByUid||l.createdBy||"",feeStatus:l.feeStatus||{term1:!1,term2:!1,term3:!1},createdAt:(null===(t=l.createdAt)||void 0===t?void 0:t.toDate)?l.createdAt.toDate():l.createdAt?new Date(l.createdAt):new Date,updatedAt:(null===(a=l.updatedAt)||void 0===a?void 0:a.toDate)?l.updatedAt.toDate():l.updatedAt?new Date(l.updatedAt):new Date}}catch(e){return console.error("Error fetching student:",e),null}}async function d(e){try{let t=(0,r.IO)((0,r.hJ)(n.db,"students"),(0,r.ar)("class","==",e),(0,r.Xo)("name"));return(await (0,r.PL)(t)).docs.map(e=>{var t,a;return{...e.data(),id:e.id,createdAt:(null===(t=e.data().createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=e.data().updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}catch(e){return console.error("Error fetching students by class:",e),[]}}async function c(e){try{let t=(await (0,r.PL)((0,r.hJ)(n.db,"students"))).docs.map(e=>{var t,a;let n=e.data(),r=n.name||[n.firstName,n.lastName].filter(Boolean).join(" ").trim();return{id:e.id,name:r,firstName:n.firstName,lastName:n.lastName,class:n.class||n.classLevel||"",classLevel:n.classLevel,email:n.email,age:n.age||0,rollNumber:n.rollNumber||e.id,parentPhone:n.parentPhone,parentEmail:n.parentEmail,photoUrl:n.photoUrl,qrCode:n.qrCode,registeredBy:n.registeredBy||"admin",registeredByUid:n.registeredByUid||n.createdBy||"",feeStatus:n.feeStatus||{term1:!1,term2:!1,term3:!1},createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate)?n.createdAt.toDate():n.createdAt?new Date(n.createdAt):new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate)?n.updatedAt.toDate():n.updatedAt?new Date(n.updatedAt):new Date}}),a=e.toLowerCase();return t.filter(e=>e.name.toLowerCase().includes(a)||e.rollNumber.toLowerCase().includes(a))}catch(e){return console.error("Error searching students:",e),[]}}async function u(e,t){try{let a={...t,updatedAt:new Date};if(t.name&&!t.firstName&&!t.lastName){let e=t.name.split(" ");e.length>1&&(a.firstName=e.slice(0,-1).join(" "),a.lastName=e.slice(-1).join(" "))}await (0,r.r7)((0,r.JU)(n.db,"students",e),a)}catch(e){throw console.error("Error updating student:",e),e}}async function m(e,t,a,s){try{let l=(0,r.JU)((0,r.hJ)(n.db,"attendance")),i={id:l.id,studentId:e,date:t,status:a,markedBy:s,markedAt:new Date};await (0,r.pl)(l,i)}catch(e){throw console.error("Error marking attendance:",e),e}}async function h(e){let t=new Date().getFullYear();return"".concat(e.replace(/\s+/g,"").toUpperCase(),"-").concat(t,"-").concat(Math.floor(1e3+9e3*Math.random()))}async function p(e){let t;let a=await h(e.classLevel);if(e.photoFile){var o;let n=e.photoFile;if(!["image/jpeg","image/jpg","image/png"].includes(n.type))throw Error("VALIDATION_UNSUPPORTED_TYPE");if(n.size>5242880)throw Error("VALIDATION_FILE_TOO_LARGE");let r=await (0,s.Z)(n,{maxSizeMB:.25,maxWidthOrHeight:600}),l=r instanceof Blob?r:new Blob([r]),d=new FormData;d.append("image",l,"".concat(a,".jpg"));let c=i.env.NEXT_PUBLIC_IMGBB_KEY||"eb795bdf868353332baf6495a1a83fa0",u=await fetch("https://api.imgbb.com/1/upload?key=".concat(c),{method:"POST",body:d}),m=await u.json();if(!u.ok||!(null==m?void 0:m.success))throw Error("IMGBB_UPLOAD_FAILED");if(!(t=null===(o=m.data)||void 0===o?void 0:o.url))throw Error("IMGBB_NO_URL_RETURNED")}let{photoFile:d,...c}=e,u={...c,id:a,photoUrl:t,feeStatus:{term1:!1,term2:!1,term3:!1},createdAt:Date.now()};await (0,r.pl)((0,r.JU)(n.db,"students",a),u);let m=window.location.origin;return{student:u,qrDataUrl:await l.toDataURL("".concat(m,"/id/").concat(a)),password:a}}async function f(e){let t=await (0,r.QT)((0,r.JU)(n.db,"students",e));return t.exists()?t.data():null}async function g(e){let t=(0,r.hJ)(n.db,"students"),a=await (0,r.PL)(t),s=e.toLowerCase();return a.docs.map(e=>({...e.data(),id:e.data().id||e.id})).filter(e=>(e.firstName||"").toLowerCase().includes(s)||(e.lastName||"").toLowerCase().includes(s)||(e.id||"").toLowerCase().includes(s))}async function x(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1?arguments[1]:void 0,a=(0,r.hJ)(n.db,"students"),s=(0,r.IO)(a,(0,r.Xo)("createdAt","desc"),(0,r.b9)(e));t&&(s=(0,r.IO)(a,(0,r.Xo)("createdAt","desc"),(0,r.TQ)(t),(0,r.b9)(e)));let l=await (0,r.PL)(s);return{students:l.docs.map(e=>({...e.data(),id:e.data().id||e.id})),cursor:l.docs.length===e?l.docs[l.docs.length-1]:null}}async function v(e,t,a){await (0,r.r7)((0,r.JU)(n.db,"students",e),{["feeStatus.".concat(t)]:a})}async function b(e,t,a){if(isNaN(new Date(t).getTime()))throw Error("Invalid date");let s=t.slice(0,7),l=(0,r.JU)(n.db,"students",e,"attendance",s),i=await (0,r.QT)(l),o=i.exists()&&i.data().days||{};o[t]=a,await (0,r.pl)(l,{days:o},{merge:!0})}async function N(e,t,a){let s="".concat(t,"-").concat(String(a).padStart(2,"0")),l=(0,r.JU)(n.db,"students",e,"attendance",s),i=await (0,r.QT)(l);return i.exists()&&i.data().days||{}}async function w(e,t,a){await (0,r.pl)((0,r.JU)(n.db,"students",e,"results",t),{subjects:a,updatedAt:Date.now()})}async function j(e,t){let a=await (0,r.QT)((0,r.JU)(n.db,"students",e,"results",t));return a.exists()?a.data():null}},9506:function(e,t,a){"use strict";let n;a.d(t,{I:function(){return u},db:function(){return p}});var r=a(5236),s=a(5735),l=a(9842),i=a(9854),o=a(357);let d={apiKey:o.env.NEXT_PUBLIC_FIREBASE_API_KEY||"AIzaSyD239JqpspNL_KN7-buMq2PTWUM5P0D5YA",authDomain:o.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN||"milliniem-86b63.firebaseapp.com",projectId:o.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID||"milliniem-86b63",storageBucket:o.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET||"milliniem-86b63.appspot.com",messagingSenderId:o.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID||"455693438371",appId:o.env.NEXT_PUBLIC_FIREBASE_APP_ID||"1:455693438371:web:0a64c5c007cb906e241e16",measurementId:o.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID||"G-KHHJRMKW9V"},c=(0,r.C6)().length?(0,r.C6)()[0]:(0,r.ZF)(d),u=(0,s.v0)(c),m="true"===o.env.NEXT_PUBLIC_FIRESTORE_FORCE_LONG_POLLING,h="true"===o.env.NEXT_PUBLIC_FIRESTORE_AUTODETECT_STREAMING;try{m||h?(n=(0,l.LV)(c,{experimentalForceLongPolling:m,experimentalAutoDetectLongPolling:h}),console.log("[firebase] Firestore initialized with options",{forceLongPolling:m,autoDetect:h})):n=(0,l.ad)(c)}catch(e){console.error("[firebase] Firestore init error, falling back to default",e),n=(0,l.ad)(c)}let p=n;(0,i.cF)(c)}},function(e){e.O(0,[358,139,712,873,726,971,23,744],function(){return e(e.s=7123)}),_N_E=e.O()}]);