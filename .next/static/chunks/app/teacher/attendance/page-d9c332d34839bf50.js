(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[18],{5872:function(e,t,a){Promise.resolve().then(a.bind(a,1478))},1478:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return u}});var n=a(7437),r=a(2265),l=a(4819),i=a(7374),s=a(3265),o=a(2469),d=a(4192),c=a(3673);function u(){return(0,n.jsx)(l.Z,{allowed:["teacher","admin"],children:(0,n.jsx)(m,{})})}function m(){let[e,t]=(0,r.useState)([]),[a,l]=(0,r.useState)(""),[u,m]=(0,r.useState)(new Date),[f,p]=(0,r.useState)(!0),[h,g]=(0,r.useState)({}),y=(0,r.useMemo)(()=>(0,s.WU)(u,"yyyy-MM"),[u]);(0,r.useEffect)(()=>{(async()=>{p(!0);let e=await (0,i.b0)(a);t(e);let n={};for(let t of e)n[t.id]=await (0,i.BM)(t.id,u.getFullYear(),u.getMonth()+1);g(n),p(!1)})()},[a,y]);let x=(0,r.useMemo)(()=>{let e=(0,o.N)(u),t=(0,d.V)(u);return(0,c.D)({start:e,end:t})},[y]);async function w(e,t){var a;let n=!!(null===(a=h[e])||void 0===a?void 0:a[t]);try{await (0,i._l)(e,t,!n),g(a=>({...a,[e]:{...a[e]||{},[t]:!n}}))}catch(e){console.error("Attendance update failed",e)}}return(0,n.jsx)("div",{className:"min-h-screen bg-slateGray py-8",children:(0,n.jsxs)("div",{className:"max-w-7xl mx-auto px-4 space-y-6",children:[(0,n.jsxs)("div",{className:"flex flex-wrap gap-4 items-center",children:[(0,n.jsxs)("h1",{className:"text-2xl font-semibold text-midnight_text",children:["Attendance - ",(0,s.WU)(u,"MMMM yyyy")]}),(0,n.jsxs)("div",{className:"flex gap-2 ml-auto items-center",children:[(0,n.jsx)("button",{onClick:()=>m(e=>new Date(e.getFullYear(),e.getMonth()-1,1)),className:"px-3 py-1 border rounded",children:"Prev"}),(0,n.jsx)("button",{onClick:()=>m(e=>new Date(e.getFullYear(),e.getMonth()+1,1)),className:"px-3 py-1 border rounded",children:"Next"}),(0,n.jsx)("input",{value:a,onChange:e=>l(e.target.value),placeholder:"Search",className:"px-3 py-1 border rounded"}),(0,n.jsx)("button",{onClick:function(){let t=new Blob([[["Student ID","Name",...x.map(e=>(0,s.WU)(e,"dd"))],...e.map(e=>{let t=h[e.id]||{};return[e.id,e.name,...x.map(e=>t[(0,s.WU)(e,"yyyy-MM-dd")]?"P":"A")]})].map(e=>e.join(",")).join("\n")],{type:"text/csv"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="attendance-".concat(y,".csv"),n.click(),URL.revokeObjectURL(a)},className:"px-3 py-1 bg-blue-600 text-white rounded text-sm",children:"Export CSV"})]})]}),(0,n.jsx)("div",{className:"overflow-auto bg-white border border-gray-200 rounded-lg",children:(0,n.jsxs)("table",{className:"min-w-full text-sm",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{className:"bg-gray-50",children:[(0,n.jsx)("th",{className:"px-3 py-2 text-left font-medium text-gray-600 sticky left-0 bg-gray-50 z-10",children:"Student"}),x.map(e=>(0,n.jsx)("th",{className:"px-1 py-1 text-center font-medium text-gray-500 w-8",children:(0,s.WU)(e,"dd")},e.toISOString()))]})}),(0,n.jsxs)("tbody",{children:[f&&(0,n.jsx)("tr",{children:(0,n.jsx)("td",{colSpan:x.length+1,className:"px-3 py-6 text-center text-gray-500",children:"Loading..."})}),!f&&0===e.length&&(0,n.jsx)("tr",{children:(0,n.jsx)("td",{colSpan:x.length+1,className:"px-3 py-6 text-center text-gray-400",children:"No students"})}),!f&&e.map(e=>{let t=h[e.id]||{};return(0,n.jsxs)("tr",{className:"border-t",children:[(0,n.jsxs)("td",{className:"px-3 py-2 whitespace-nowrap sticky left-0 bg-white z-10 font-medium text-gray-700",children:[e.name,(0,n.jsx)("div",{className:"text-[10px] text-gray-400",children:e.class})]}),x.map(a=>{let r=(0,s.WU)(a,"yyyy-MM-dd"),l=!!t[r];return(0,n.jsx)("td",{className:"px-0.5 py-0.5 text-center",children:(0,n.jsx)("button",{onClick:()=>w(e.id,r),className:"w-8 h-8 rounded text-[11px] font-semibold border transition ".concat(l?"bg-green-500 text-black border-green-500":"bg-gray-50 text-gray-400 border-gray-300 hover:bg-gray-100"),children:l?"P":"A"})},r)})]},e.id)})]})]})})]})})}},4819:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var n=a(7437),r=a(2265),l=a(6463),i=a(9630);function s(e){let{allowed:t,children:a}=e,{loading:s,roleInfo:o,isOverrideAdmin:d}=(0,i.a)(),c=(0,l.useRouter)(),u=(null==o?void 0:o.role)||(d?"admin":null);return((0,r.useEffect)(()=>{s||u&&t.includes(u)||c.replace("/login")},[s,u,t,c]),s)?(0,n.jsx)("p",{className:"text-center py-10 text-white/80",children:"Loading..."}):u&&t.includes(u)?(0,n.jsx)(n.Fragment,{children:a}):null}},9630:function(e,t,a){"use strict";a.d(t,{AuthProvider:function(){return d},a:function(){return c}});var n=a(7437),r=a(2265),l=a(5735),i=a(9842),s=a(9506);let o=(0,r.createContext)({user:null,loading:!0,roleInfo:null,logout:async()=>{},isOverrideAdmin:!1,enableAdminOverride:()=>{}}),d=e=>{let{children:t}=e,[a,d]=(0,r.useState)(null),[c,u]=(0,r.useState)(!0),[m,f]=(0,r.useState)(null),[p,h]=(0,r.useState)(!!localStorage.getItem("overrideAdmin"));async function g(){localStorage.removeItem("overrideAdmin"),s.I.currentUser&&await (0,l.w7)(s.I)}return(0,r.useEffect)(()=>{let e=(0,l.Aj)(s.I,async e=>{d(e);let t=localStorage.getItem("pendingRole");if(e){let a=(0,i.JU)(s.db,"users",e.uid),n=await (0,i.QT)(a);if(n.exists()){let e=n.data();f({role:e.role,studentId:e.studentId,classLevels:e.classLevels})}else t?f({role:t}):f(null)}else f(null);u(!1),t&&localStorage.removeItem("pendingRole")});return()=>e()},[]),(0,n.jsx)(o.Provider,{value:{user:a,loading:c,roleInfo:m||(p?{role:"admin"}:null),logout:g,isOverrideAdmin:p,enableAdminOverride:function(){localStorage.setItem("overrideAdmin","true"),h(!0),f({role:"admin"})}},children:t})},c=()=>(0,r.useContext)(o)},7374:function(e,t,a){"use strict";a.d(t,{BM:function(){return b},Gc:function(){return u},KD:function(){return o},O7:function(){return N},QN:function(){return y},Wv:function(){return h},YF:function(){return m},_8:function(){return d},_l:function(){return w},b0:function(){return c},iM:function(){return v},l6:function(){return g},tS:function(){return p},y7:function(){return x}});var n=a(9506),r=a(9842),l=a(2107),i=a(9783),s=a(357);async function o(e){try{var t,a;let l=await (0,r.QT)((0,r.JU)(n.db,"students",e));if(!l.exists())return null;let i=l.data(),s=i.name||[i.firstName,i.lastName].filter(Boolean).join(" ").trim();return{id:l.id,name:s,firstName:i.firstName,lastName:i.lastName,class:i.class||i.classLevel||"",classLevel:i.classLevel,email:i.email,age:i.age||0,rollNumber:i.rollNumber||i.id||"",parentPhone:i.parentPhone,parentEmail:i.parentEmail,photoUrl:i.photoUrl,qrCode:i.qrCode,registeredBy:i.registeredBy||"admin",registeredByUid:i.registeredByUid||i.createdBy||"",feeStatus:i.feeStatus||{term1:!1,term2:!1,term3:!1},createdAt:(null===(t=i.createdAt)||void 0===t?void 0:t.toDate)?i.createdAt.toDate():i.createdAt?new Date(i.createdAt):new Date,updatedAt:(null===(a=i.updatedAt)||void 0===a?void 0:a.toDate)?i.updatedAt.toDate():i.updatedAt?new Date(i.updatedAt):new Date}}catch(e){return console.error("Error fetching student:",e),null}}async function d(e){try{let t=(0,r.IO)((0,r.hJ)(n.db,"students"),(0,r.ar)("class","==",e),(0,r.Xo)("name"));return(await (0,r.PL)(t)).docs.map(e=>{var t,a;return{...e.data(),id:e.id,createdAt:(null===(t=e.data().createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=e.data().updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}catch(e){return console.error("Error fetching students by class:",e),[]}}async function c(e){try{let t=(await (0,r.PL)((0,r.hJ)(n.db,"students"))).docs.map(e=>{var t,a;let n=e.data(),r=n.name||[n.firstName,n.lastName].filter(Boolean).join(" ").trim();return{id:e.id,name:r,firstName:n.firstName,lastName:n.lastName,class:n.class||n.classLevel||"",classLevel:n.classLevel,email:n.email,age:n.age||0,rollNumber:n.rollNumber||e.id,parentPhone:n.parentPhone,parentEmail:n.parentEmail,photoUrl:n.photoUrl,qrCode:n.qrCode,registeredBy:n.registeredBy||"admin",registeredByUid:n.registeredByUid||n.createdBy||"",feeStatus:n.feeStatus||{term1:!1,term2:!1,term3:!1},createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate)?n.createdAt.toDate():n.createdAt?new Date(n.createdAt):new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate)?n.updatedAt.toDate():n.updatedAt?new Date(n.updatedAt):new Date}}),a=e.toLowerCase();return t.filter(e=>e.name.toLowerCase().includes(a)||e.rollNumber.toLowerCase().includes(a))}catch(e){return console.error("Error searching students:",e),[]}}async function u(e,t){try{let a={...t,updatedAt:new Date};if(t.name&&!t.firstName&&!t.lastName){let e=t.name.split(" ");e.length>1&&(a.firstName=e.slice(0,-1).join(" "),a.lastName=e.slice(-1).join(" "))}await (0,r.r7)((0,r.JU)(n.db,"students",e),a)}catch(e){throw console.error("Error updating student:",e),e}}async function m(e,t,a,l){try{let i=(0,r.JU)((0,r.hJ)(n.db,"attendance")),s={id:i.id,studentId:e,date:t,status:a,markedBy:l,markedAt:new Date};await (0,r.pl)(i,s)}catch(e){throw console.error("Error marking attendance:",e),e}}async function f(e){let t=new Date().getFullYear();return"".concat(e.replace(/\s+/g,"").toUpperCase(),"-").concat(t,"-").concat(Math.floor(1e3+9e3*Math.random()))}async function p(e){let t;let a=await f(e.classLevel);if(e.photoFile){var o;let n=e.photoFile;if(!["image/jpeg","image/jpg","image/png"].includes(n.type))throw Error("VALIDATION_UNSUPPORTED_TYPE");if(n.size>5242880)throw Error("VALIDATION_FILE_TOO_LARGE");let r=await (0,l.Z)(n,{maxSizeMB:.25,maxWidthOrHeight:600}),i=r instanceof Blob?r:new Blob([r]),d=new FormData;d.append("image",i,"".concat(a,".jpg"));let c=s.env.NEXT_PUBLIC_IMGBB_KEY||"eb795bdf868353332baf6495a1a83fa0",u=await fetch("https://api.imgbb.com/1/upload?key=".concat(c),{method:"POST",body:d}),m=await u.json();if(!u.ok||!(null==m?void 0:m.success))throw Error("IMGBB_UPLOAD_FAILED");if(!(t=null===(o=m.data)||void 0===o?void 0:o.url))throw Error("IMGBB_NO_URL_RETURNED")}let{photoFile:d,...c}=e,u={...c,id:a,photoUrl:t,feeStatus:{term1:!1,term2:!1,term3:!1},createdAt:Date.now()};await (0,r.pl)((0,r.JU)(n.db,"students",a),u);let m=window.location.origin;return{student:u,qrDataUrl:await i.toDataURL("".concat(m,"/id/").concat(a)),password:a}}async function h(e){let t=await (0,r.QT)((0,r.JU)(n.db,"students",e));return t.exists()?t.data():null}async function g(e){let t=(0,r.hJ)(n.db,"students"),a=await (0,r.PL)(t),l=e.toLowerCase();return a.docs.map(e=>({...e.data(),id:e.data().id||e.id})).filter(e=>(e.firstName||"").toLowerCase().includes(l)||(e.lastName||"").toLowerCase().includes(l)||(e.id||"").toLowerCase().includes(l))}async function y(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1?arguments[1]:void 0,a=(0,r.hJ)(n.db,"students"),l=(0,r.IO)(a,(0,r.Xo)("createdAt","desc"),(0,r.b9)(e));t&&(l=(0,r.IO)(a,(0,r.Xo)("createdAt","desc"),(0,r.TQ)(t),(0,r.b9)(e)));let i=await (0,r.PL)(l);return{students:i.docs.map(e=>({...e.data(),id:e.data().id||e.id})),cursor:i.docs.length===e?i.docs[i.docs.length-1]:null}}async function x(e,t,a){await (0,r.r7)((0,r.JU)(n.db,"students",e),{["feeStatus.".concat(t)]:a})}async function w(e,t,a){if(isNaN(new Date(t).getTime()))throw Error("Invalid date");let l=t.slice(0,7),i=(0,r.JU)(n.db,"students",e,"attendance",l),s=await (0,r.QT)(i),o=s.exists()&&s.data().days||{};o[t]=a,await (0,r.pl)(i,{days:o},{merge:!0})}async function b(e,t,a){let l="".concat(t,"-").concat(String(a).padStart(2,"0")),i=(0,r.JU)(n.db,"students",e,"attendance",l),s=await (0,r.QT)(i);return s.exists()&&s.data().days||{}}async function v(e,t,a){await (0,r.pl)((0,r.JU)(n.db,"students",e,"results",t),{subjects:a,updatedAt:Date.now()})}async function N(e,t){let a=await (0,r.QT)((0,r.JU)(n.db,"students",e,"results",t));return a.exists()?a.data():null}},9506:function(e,t,a){"use strict";let n;a.d(t,{I:function(){return u},db:function(){return p}});var r=a(5236),l=a(5735),i=a(9842),s=a(9854),o=a(357);let d={apiKey:o.env.NEXT_PUBLIC_FIREBASE_API_KEY||"AIzaSyD239JqpspNL_KN7-buMq2PTWUM5P0D5YA",authDomain:o.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN||"milliniem-86b63.firebaseapp.com",projectId:o.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID||"milliniem-86b63",storageBucket:o.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET||"milliniem-86b63.appspot.com",messagingSenderId:o.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID||"455693438371",appId:o.env.NEXT_PUBLIC_FIREBASE_APP_ID||"1:455693438371:web:0a64c5c007cb906e241e16",measurementId:o.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID||"G-KHHJRMKW9V"},c=(0,r.C6)().length?(0,r.C6)()[0]:(0,r.ZF)(d),u=(0,l.v0)(c),m="true"===o.env.NEXT_PUBLIC_FIRESTORE_FORCE_LONG_POLLING,f="true"===o.env.NEXT_PUBLIC_FIRESTORE_AUTODETECT_STREAMING;try{m||f?(n=(0,i.LV)(c,{experimentalForceLongPolling:m,experimentalAutoDetectLongPolling:f}),console.log("[firebase] Firestore initialized with options",{forceLongPolling:m,autoDetect:f})):n=(0,i.ad)(c)}catch(e){console.error("[firebase] Firestore init error, falling back to default",e),n=(0,i.ad)(c)}let p=n;(0,s.cF)(c)}},function(e){e.O(0,[358,139,712,873,749,971,23,744],function(){return e(e.s=5872)}),_N_E=e.O()}]);